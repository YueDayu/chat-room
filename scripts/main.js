!function(){"use strict";var a=0,b=[],c=[],d=$("#msg-area")[0],e=$("#chat-user-list")[0],f=$("#chat-title"),g=$("#user-input"),h=$("#room-list")[0],i=null,j=null,k=new Firebase("https://chatting-room.firebaseio.com/all-online-user"),l=new Firebase("https://chatting-room.firebaseio.com/rooms"),m=[],n=[],o=null,p=1,q=$("#error"),r=$("#error-msg"),s=$("#myModal"),t=$("#user_name"),u=null,v=0,w=function(a){for(var c in b)if(b[c].name==a)return b[c].photo;return 1},x=function(a){var b=a.text.replace("\n","<br/>");d.innerHTML+="<div class='"+(o==a.name?"my-msg":"other-msg")+"'>                           <img class='chat-photo' src='images/photos/00"+a.photo+".jpg'/><div class='content'><span>"+a.name+"</span><br/><div><p class='panel panel-default'>"+b+"</p></div></div></div>",d.scrollTop=d.scrollHeight,emojify.run()},y=function(a){d.innerHTML="";for(var b in c[a].chats)x(c[a].chats[b])},z=function(a){f.html(c[a].name+"("+c[a].users.length+")"),e.innerHTML="";for(var b in c[a].users){var d=c[a].users[b].name,g=w(d);e.innerHTML+="<li title="+d+"><img class='chat-photo' src='images/photos/00"+g+".jpg'/><br/><span>"+d+"</span></li>"}},A=function(){if(v>=2){z(0),G(c),s.off("hide.bs.modal"),v=-1,u=$(".room"),u.each(function(b,c){c.onclick=function(){var b=Number(this.getAttribute("index"));b!=a&&(u.each(function(a,b){b.setAttribute("class","room")}),this.setAttribute("class","room on-active"),E(a),a=b,m[a].push(o),z(a),y(a))}});for(var b in c)m.push(new Firebase("https://chatting-room.firebaseio.com/rooms/"+c[b].url+"/users")),n.push(new Firebase("https://chatting-room.firebaseio.com/rooms/"+c[b].url+"/chats")),m[b].on("value",function(b){var d=0;for(var e in c)if(c[e].url==b.ref().path.n[1]){d=e;break}c[d].users=$.map(b.val(),function(a,b){return a==o&&(j=b),{url:b,name:a}}),d==a&&z(d)}),n[b].on("child_added",function(b){var d=0;for(var e in c)if(c[e].url==b.ref().path.n[1]){d=e;break}var f=b.val();c[d].chats.push(f),d==a&&x(f)})}},B=function(a){r.html(a),q.show()},C=function(){q.hide()},D=function(){if(0==v||1==v)return B("请等待数据获取完毕"),!1;var a=t.val();if(""==a)return B("请输入用户名"),!1;for(var c in b)if(b[c].name==a)return B("该用户已经存在"),!1;var d=$("input[name='rd']:checked").val();return d?(d=Number(d),{name:a,photo:d}):(B("请选择一个头像"),!1)},E=function(a){null!=o&&null!=j&&m[a].child(j).set(null)},F=function(){null!=o&&null!=i&&k.child(i).set(null),E(a)},G=function(a){var b=0;for(var c in a)b++,h.innerHTML+="<div index="+c+" class='room"+(0==c?" on-active":"")+"'>                                       <div class='room-info'>                                       <img src='images/photos/room-"+b+".jpg'/>                                       <span>"+a[c].name+"</span></div></div><hr class='no-margin'/>",b>6&&(b=0)};k.on("value",function(a){b=$.map(a.val(),function(a,b){return a.name==o&&(i=b),{url:b,name:a.name,photo:a.photo}}),-1!=v&&(v++,A())}),l.once("value",function(a){c=$.map(a.val(),function(a,b){var c=$.map(a.users,function(a,b){return{name:a,url:b}});return{url:b,users:c,name:a.name,chats:[]}}),-1!=v&&(v++,A())}),emojify.setConfig({img_dir:"./images/emoji"}),emojify.run(),d.scrollTop=d.scrollHeight;var H=$(".face-show");H.each(function(a,b){b.onclick=function(){var a=g.val();g.val(a+" "+this.children[0].alt+" "),g.focus()}}),$("#close-error-btn").click(function(){C()}),s.modal("show").on("hide.bs.modal",function(a){return B("请等待数据获取完毕"),!1}),$("#submit-data").click(function(){var b=D();"object"==typeof b&&(F(),o=b.name,p=b.photo,k.push({name:o,photo:p}),m[a].push(o),$("#photo")[0].src="images/photos/00"+p+".jpg",$("#name")[0].innerHTML=o,y(a),s.modal("hide"),C())}),$("#person-info").click(function(){C(),s.modal("show")}),$("#send").click(function(){if(null==o)return B("请先登录"),void s.modal("show");var b=g.val();""!=b&&(n[a].push({name:o,text:b,photo:p}),g.val(""))}),$(window).on("beforeunload",function(){return F(),null!=o?"确定退出登录吗？":void 0}),g.keypress(function(a){!a.ctrlKey||13!=a.which&&10!=a.which||$("#send").trigger("click")})}();